<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>赛菲莉娅武器投票 - 全服实时榜单</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; text-align: center; padding: 20px; }
        .container { display: flex; justify-content: center; gap: 20px; margin-top: 30px; flex-wrap: wrap; }
        .card { background: #1e293b; padding: 20px; border-radius: 15px; width: 250px; cursor: pointer; border: 2px solid transparent; transition: 0.3s; position: relative; }
        .card:hover { border-color: #fbbf24; transform: translateY(-5px); }
        .card.loading { opacity: 0.5; pointer-events: none; }
        img { width: 100%; height: 200px; object-fit: contain; background: #000; border-radius: 10px; }
        .vs { font-size: 2rem; font-weight: bold; color: #ef4444; align-self: center; }
        #progress { color: #94a3b8; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>赛菲莉娅：哪把武器更强？</h1>
    <p id="progress">正在连接数据库...</p>
    
    <div class="container">
        <div class="card" id="card1" onclick="vote(1)">
            <img id="img1" src="">
            <p id="name1">加载中...</p>
        </div>
        <div class="vs">VS</div>
        <div class="card" id="card2" onclick="vote(2)">
            <img id="img2" src="">
            <p id="name2">加载中...</p>
        </div>
    </div>

<script>
    // ======= 1. 配置信息 =======
    const SUPABASE_URL = "https://qdrqekpzaexmkyckhjlw.supabase.co"; 
    const SUPABASE_KEY = "sb_publishable_YivlajEIEQghleyC0hxBYQ_X7AihGf_M4yK03m_Wz-fW-E5T2v-0"; // 请确保这是完整的 anon key
    
    const githubUser = "DFM05";
    const repoName = "Sephira-Weapon-Images";
    // ==========================

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let count = 1;
    let id1, id2;
    const weaponNames = ["希望的影子","无光之刃","爬行绝望","炙热之刃","笼罩的阴云","福寿草","白色微笑","绝对向往","艰难实验","燃烧之牙","雷电之怒","无尽沉浸","黑幕","默杀","短暂自责","荆棘棒","吱嘎的脊椎","万年寒霜巨剑","深红漩涡","电击大剑【E3G】","幻术师的遗产","爱的眼神","顽皮的恶作剧","冰柱剑","裁判官","电击大剑【S3G】","太初形态","驱魔的重剑","拉扎里恩","红蛇碎击","索利斯灰烬","星光闪烁","灰烬飘扬","收紧的恐惧","胡萝卜剑","闪光的细剑","火焰凝视","冰川之刃","弩炮剑","冰冷愤怒","无垠原野","葱根剑","冰之呼吸","暴风雪的前奏","超导体","雷电之翼的振动","重型弩：加速核心","重型弩：火药合成","重型弩：连发装置","重型弩：配备制导模块","重型弩：标记稳定化","重型弩：速冻结晶","弩：双子","重型弩：爆炸装置","迷你加农炮","重型弩：聚云者","重型弩：扩展装置","卡里姆的形象","名刀【村正】","怪刀【毫羽】","炽焰赫尔巴努斯","海蒂","剑斩刀：飞柳","斩剑刀：破舞","优衣的短匕首","亚达玛的誓约","图书馆幽灵封印研究会第2型","永霜的沉默","纳斯特朗的碎片","电光一刻"];

    async function refresh() {
        if (count > 50) {
            alert("感谢参与！50轮投票已完成。");
            location.reload();
            return;
        }
        
        document.getElementById('progress').innerText = `进度: ${count} / 50`;
        
        id1 = Math.floor(Math.random() * 70) + 1;
        do { id2 = Math.floor(Math.random() * 70) + 1; } while(id1 === id2);

        document.getElementById('img1').src = `https://raw.githubusercontent.com/${githubUser}/${repoName}/main/${id1}.png`;
        document.getElementById('img2').src = `https://raw.githubusercontent.com/${githubUser}/${repoName}/main/${id2}.png`;
        document.getElementById('name1').innerText = weaponNames[id1 - 1] || `武器 #${id1}`;
        document.getElementById('name2').innerText = weaponNames[id2 - 1] || `武器 #${id2}`;
        
        await supabaseClient.rpc('increment_views', { ids: [id1, id2] });
    }

    async function vote(choice) {
        const winnerId = (choice === 1) ? id1 : id2;
        document.getElementById('card1').classList.add('loading');
        document.getElementById('card2').classList.add('loading');

        await supabaseClient.rpc('increment_votes', { winner_id: winnerId });

        count++;
        document.getElementById('card1').classList.remove('loading');
        document.getElementById('card2').classList.remove('loading');
        refresh();
    }

    refresh();
</script>
</body>
</html>